// This is your Prisma schema file,
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum ResourceType {
  SSH
  WEB_APP
  RDP
  VPN
}

enum ResourceStatus {
  ONLINE
  OFFLINE
  MAINTENANCE
}

enum BookingStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  
  bookings  Booking[]
  actionLogs ActionLog[]
  accessLogs AccessLog[]
}

model LabResource {
  id        String         @id @default(cuid())
  name      String
  type      ResourceType
  config    Json // JSON config for credentials/URLs
  active    Boolean        @default(true)
  status    ResourceStatus @default(ONLINE)
  createdAt DateTime       @default(now())
  
  labTypes  LabTypeResource[]
}

model LabType {
  id              String   @id @default(cuid())
  name            String
  maxDurationHours Float?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  resources       LabTypeResource[]
  bookings        Booking[]
}

model LabTypeResource {
  id          String     @id @default(cuid())
  labTypeId   String
  resourceId  String
  createdAt   DateTime   @default(now())
  
  labType     LabType    @relation(fields: [labTypeId], references: [id], onDelete: Cascade)
  resource    LabResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@unique([labTypeId, resourceId])
  @@index([labTypeId])
  @@index([resourceId])
}

model Booking {
  id              String        @id @default(cuid())
  userId          String
  labTypeId       String
  startTime       DateTime
  endTime         DateTime
  status          BookingStatus @default(ACTIVE)
  bookingPassword String        // Hashed password
  notes           String?       // Optional notes
  createdAt       DateTime       @default(now())
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  labType         LabType       @relation(fields: [labTypeId], references: [id], onDelete: Cascade)
  accessLogs      AccessLog[]
  
  @@index([userId])
  @@index([labTypeId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
}

model ActionLog {
  id          String   @id @default(cuid())
  action      String
  userId      String
  targetType  String?  // e.g., "Booking", "LabResource", "User"
  targetId    String?
  details     Json?    // Additional details as JSON
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model AccessLog {
  id          String   @id @default(cuid())
  bookingId   String?
  userId      String
  accessedAt  DateTime @default(now())
  ipAddress  String?
  
  booking     Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([bookingId])
  @@index([userId])
  @@index([accessedAt])
}
